{# @var craft \craft\web\twig\variables\CraftVariable #}
{#
/**
 * Views Work plugin for Craft CMS 3.x
 *
 * Views Work Settings.twig
 *
 * @author    24hoursmedia
 * @copyright Copyright (c) 2018 24hoursmedia
 * @link      http://www.24hoursmedia.com
 * @package   ViewsWork
 * @since     1.0.0
 */
#}

{% import "_includes/forms" as forms %}

{% do view.registerAssetBundle("twentyfourhoursmedia\\viewswork\\assetbundles\\viewswork\\ViewsWorkAsset") %}

{{ forms.textField({
    label: 'Signing key',
    instructions: 'Enter a secret key here. It is used to digitally sign tracking urls so people cannot tamper with it. If you leave it empty and save, a cryptographically secure key is automatically generated.',
    id: 'signKey',
    name: 'signKey',
    value: settings['signKey']}) }}


<hr/>

<h3>Resetting views</h3>


<div class="row">
    <div class="col-5">
        <p>{{ 'You can reset the daily, weekly and hourly views with a special url or through a cron job.' | t('views-work') }}</p>
        <p>{{ 'If your server does not support cron jobs, you can use an external service to call the secret url (typically once every night some minutes after midnight).' | t('views-work') }}</p>
        <p>
            <em>
                {{ 'A service that can execute crons through urls can be found at:' }}
                <a href="https://www.easycron.com" rel="noopener noreferrer" target="_blank">www.easycron.com</a>.
                {{ 'Note that the url request needs to be a POST request.' }}
            </em>
        </p>

        {% if not settings.allowUrlReset %}
            <p>{{ 'After enabling \'resetting views through a secret url\', you can view the secret urls here.' }}</p>
        {% endif %}
    </div>
    <div class="col col-2"></div>
    <div class="col-5">
        {{ forms.lightswitch({
            label: 'Allow resetting views through a secret url',
            id: 'allowUrlReset',
            name: 'allowUrlReset',
            on: settings['allowUrlReset'],
            value: 1
        }) }}
        {{ forms.textField({
            label:'Reset URL Secret',
            instructions: 'Enter a secret for url resetting here. Or use the default autogenerated one.',
            id: 'urlResetSecret',
            name: 'urlResetSecret',
            value: settings['urlResetSecret']}) }}
    </div>
</div>
{% if settings.allowUrlReset %}
    <div class="row">
        <div class="col-12">
            <br/>
            <p>The secret url to reset daily, weekly and monthly views is:</p>
            <p><strong>
                    POST<br/>
                    <small>
                        {{ siteUrl('views-work/reset', {key: settings.urlResetSecret}) }}
                    </small>
                </strong></p>
        </div>
    </div>
{% endif %}

<br/><br/>
<strong>CRON JOB</strong>
<p>
    In order to reset the daily, monthly and weekly view with a cron job,
    you should execute the command bellow to run every night, for example at 00:05.
</p>

The command to execute:

<br/><br/>
<code>
    php /path_to_project/craft views-work/default/reset-views
</code>
<br/><br/>

Example of a line in crontab file:
<br/><br/>
<code>
    5 0 * * * php /path_to_project/craft views-work/default/reset-views
</code>
<br/><br/>
